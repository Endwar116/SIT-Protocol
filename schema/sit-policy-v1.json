{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/Endwar116/SIT-Protocol/schema/sit-policy-v1.json",
  "title": "SIT Policy v1.0",
  "description": "Policy rules for Semantic Firewall validation",
  "type": "object",
  "required": ["policy_version", "policy_id", "rules"],
  
  "properties": {
    "policy_version": {
      "type": "string",
      "const": "1.0"
    },
    
    "policy_id": {
      "type": "string",
      "pattern": "^[a-zA-Z0-9_-]{1,64}$"
    },
    
    "name": {
      "type": "string",
      "maxLength": 128
    },
    
    "description": {
      "type": "string",
      "maxLength": 512
    },
    
    "rules": {
      "type": "array",
      "items": { "$ref": "#/$defs/rule" },
      "minItems": 1
    },
    
    "default_action": {
      "type": "string",
      "enum": ["ALLOW", "DENY"],
      "default": "DENY",
      "description": "Action when no rules match (deny by default)"
    }
  },
  
  "$defs": {
    "rule": {
      "type": "object",
      "required": ["rule_id", "conditions", "action"],
      "properties": {
        "rule_id": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9_-]{1,32}$"
        },
        
        "priority": {
          "type": "integer",
          "minimum": 1,
          "maximum": 1000,
          "default": 100,
          "description": "Lower number = higher priority"
        },
        
        "conditions": {
          "type": "object",
          "properties": {
            "match_all": {
              "type": "array",
              "items": { "$ref": "#/$defs/condition" },
              "description": "ALL conditions must be true (AND)"
            },
            "match_any": {
              "type": "array",
              "items": { "$ref": "#/$defs/condition" },
              "description": "ANY condition must be true (OR)"
            }
          }
        },
        
        "action": {
          "type": "string",
          "enum": ["ALLOW", "DENY", "TRANSFORM", "ESCALATE", "LOG"]
        },
        
        "transform": {
          "type": "object",
          "description": "If action=TRANSFORM, how to modify the SIT State",
          "properties": {
            "redact_fields": {
              "type": "array",
              "items": { "type": "string" }
            },
            "force_scope": {
              "type": "object"
            },
            "downgrade_clearance": {
              "type": "integer"
            }
          }
        },
        
        "log_level": {
          "type": "string",
          "enum": ["DEBUG", "INFO", "WARN", "ERROR", "CRITICAL"],
          "default": "INFO"
        }
      }
    },
    
    "condition": {
      "type": "object",
      "required": ["field", "operator", "value"],
      "properties": {
        "field": {
          "type": "string",
          "description": "JSON path in SIT State (e.g., 'requester.role', 'intent.action')"
        },
        "operator": {
          "type": "string",
          "enum": [
            "eq", "neq", "gt", "gte", "lt", "lte",
            "in", "not_in", "contains", "not_contains",
            "matches", "not_matches", "exists", "not_exists"
          ]
        },
        "value": {
          "description": "Value to compare against"
        }
      }
    }
  }
}
